<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المراجعات - ReviewQeem</title>
    
    <!-- تمت إزالة تحميل الخطوط من الإنترنت (Font Awesome + Google Fonts)
         نعتمد فقط على خطوط النظام المحلية -->
    
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* ==================== RESET & VARIABLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6c5ce7;
            --primary-dark: #5f3dc4;
            --secondary: #00b894;
            --accent: #fd79a8;
            --dark-bg: #0d0d11;
            --darker-bg: #05050a;
            --card-bg: #1a1a24;
            --text-primary: #ffffff;
            --text-secondary: #b8b8cc;
            --border-color: #2a2a3a;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e74c3c;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
            --ps-blue: #003087;
            --xbox-green: #107c10;
            --nintendo-red: #e60012;
            --steam-blue: #1b2838;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, Arial, sans-serif;
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ==================== HEADER ==================== */
        header {
            background: rgba(13, 13, 17, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-mark {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: radial-gradient(circle at 30% 30%, #ffeaa7 0%, #fd79a8 30%, #6c5ce7 70%, #241b52 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            color: #fff;
            box-shadow: 0 8px 24px rgba(108, 92, 231, 0.3);
            transition: transform 0.3s ease;
        }

        .logo-mark:hover {
            transform: rotate(15deg);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #ffffff 0%, #dfe6e9 40%, #a29bfe 70%, #81ecec 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
        }

        nav ul {
            display: flex;
            gap: 30px;
            list-style: none;
            align-items: center;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            padding: 8px 0;
        }

        nav a:hover,
        nav a.active {
            color: var(--primary);
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        nav a:hover::after,
        nav a.active::after {
            width: 100%;
        }

        /* ==================== MAIN CONTENT ==================== */
        .management-header {
            text-align: center;
            margin-bottom: 50px;
            padding: 40px 0;
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1) 0%, rgba(0, 184, 148, 0.05) 100%);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .management-header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .management-header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ==================== CONTROLS ==================== */
        .management-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .search-box {
            position: relative;
            width: 350px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            background: var(--darker-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
        }

        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
            outline: none;
        }

        .search-box i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: 'Tajawal', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(108, 92, 231, 0.4);
        }

        /* ==================== REVIEWS TABLE ==================== */
        .reviews-table-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            margin-bottom: 40px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .table-header h2 {
            color: var(--primary);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reviews-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reviews-table th {
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--card-bg) 100%);
            padding: 18px;
            text-align: right;
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.95rem;
        }

        .reviews-table td {
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .reviews-table tr {
            transition: all 0.3s ease;
        }

        .reviews-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(-5px);
        }

        .reviews-table tr:hover td {
            color: var(--text-primary);
        }

        .review-image {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            background: var(--darker-bg);
        }

        .reviews-table tr:hover .review-image {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .rating-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-published {
            background: rgba(0, 184, 148, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-draft {
            background: rgba(253, 203, 110, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 8px;
        }

        .btn-edit {
            background: rgba(108, 92, 231, 0.15);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-edit:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-2px);
        }

        /* ==================== MODAL ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 20px auto;
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            width: 95%;
            max-width: 1000px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            background: var(--darker-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Tajawal', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        /* Rating Indicator */
        .rating-indicator {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rating-bar {
            flex: 1;
            height: 8px;
            background: var(--darker-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .rating-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--success) 100%);
            transition: width 0.3s ease;
        }
        
        .rating-text {
            color: var(--text-primary);
            font-weight: 600;
            min-width: 50px;
        }
        
        /* Content Editor */
        .content-editor {
            background: var(--darker-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
        }

        /* Quill Editor Custom Styling */
        #review-content-editor .ql-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, Arial, sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--darker-bg);
            border: none;
            border-top: 1px solid var(--border-color);
            min-height: 300px;
            direction: rtl; /* دعم اللغة العربية */
        }

        #review-content-editor .ql-editor {
            min-height: 300px;
            color: var(--text-primary);
            line-height: 1.8;
            direction: rtl; /* دعم اللغة العربية */
            text-align: right; /* محاذاة النص لليمين */
        }

        #review-content-editor .ql-editor.ql-blank::before {
            color: var(--text-secondary);
            font-style: normal;
        }

        #review-content-editor .ql-toolbar {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            padding: 12px;
        }

        #review-content-editor .ql-toolbar .ql-stroke {
            stroke: var(--text-primary);
        }

        #review-content-editor .ql-toolbar .ql-fill {
            fill: var(--text-primary);
        }

        #review-content-editor .ql-toolbar button:hover,
        #review-content-editor .ql-toolbar button.ql-active {
            color: var(--primary);
        }

        #review-content-editor .ql-toolbar button:hover .ql-stroke,
        #review-content-editor .ql-toolbar button.ql-active .ql-stroke {
            stroke: var(--primary);
        }

        #review-content-editor .ql-toolbar button:hover .ql-fill,
        #review-content-editor .ql-toolbar button.ql-active .ql-fill {
            fill: var(--primary);
        }

        /* Inline Images Styling - صور مربعة (نفس العرض والطول) */
        #review-content-editor .ql-editor img {
            width: 400px;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
            margin: 20px auto;
            display: block;
        }

        /* Custom Image Upload Button */
        .ql-image-upload {
            position: relative;
            display: inline-block;
        }

        .ql-image-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .editor-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .editor-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .editor-blocks {
            min-height: 200px;
        }
        
        .editor-block {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
        }
        
        .editor-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .editor-block-type {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .editor-block-delete {
            background: var(--danger);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .editor-block-content {
            width: 100%;
        }
        
        .editor-block textarea {
            width: 100%;
            min-height: 100px;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
        }
        
        .editor-block-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .editor-block-image-upload {
            background: var(--darker-bg);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .editor-block-image-upload:hover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-actions {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid var(--border-color);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* ==================== IMAGE UPLOAD ==================== */
        .image-upload-container {
            margin-top: 15px;
            padding: 20px;
            background: var(--darker-bg);
            border-radius: 12px;
            border: 2px dashed var(--border-color);
            text-align: center;
        }

        .image-upload-container.dragover {
            border-color: var(--primary);
            background: rgba(108, 92, 231, 0.1);
        }

        .upload-area {
            cursor: pointer;
            padding: 20px;
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .upload-area p {
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .upload-btn {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            cursor: pointer;
            margin-top: 10px;
        }

        .upload-btn:hover {
            background: var(--primary-dark);
        }

        #image-upload-input {
            display: none;
        }

        .image-preview-container {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            min-height: 120px;
            align-items: flex-start;
        }

        .image-preview {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-color);
            background: var(--darker-bg);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .upload-progress {
            width: 100%;
            height: 5px;
            background: var(--border-color);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ==================== PURCHASE LINKS ==================== */
        .purchase-links-section {
            background: var(--darker-bg);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .section-title {
            color: var(--primary);
            font-size: 1.4rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .platforms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .platform-item {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .platform-item:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .platform-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .platform-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .platform-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .platform-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .platform-input {
            flex: 1;
            min-width: 120px;
        }

        .platform-input label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .platform-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .platform-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .platform-checkbox label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .ps5 { background: linear-gradient(135deg, #003087, #0072ce); color: white; }
        .pc { background: linear-gradient(135deg, #1b2838, #2a475e); color: white; }
        .xbox-series { background: linear-gradient(135deg, #107c10, #5dc21e); color: white; }
        .switch-icon { background: linear-gradient(135deg, #e60012, #ff6b6b); color: white; }

        /* ==================== COMMENTS CONTROL ==================== */
        .comments-control {
            background: var(--darker-bg);
            border-radius: 14px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-color);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* ==================== ALERT ==================== */
        .alert {
            padding: 18px 25px;
            border-radius: 12px;
            margin: 25px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .alert-success {
            background: rgba(0, 184, 148, 0.15);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        /* ==================== LOADING & EMPTY ==================== */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--border-color);
            margin-bottom: 25px;
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .management-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box { width: 100%; }
            .form-row { grid-template-columns: 1fr; }
            .platforms-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>

<body>
    <!-- نظام الجلسة الجديد -->
    <script>
        // نظام الجلسة الجديد
        document.addEventListener("DOMContentLoaded", () => {
            const session = JSON.parse(localStorage.getItem("admin_session_reviewqeem"));

            // لا توجد جلسة → رجوع إلى تسجيل الدخول
            if (!session || !session.data) {
                window.location.href = "admin.html";
                return;
            }

            // انتهت الجلسة → تنظيف ورجوع للدخول
            if (Date.now() > session.expires) {
                localStorage.removeItem("admin_session_reviewqeem");
                window.location.href = "admin.html";
                return;
            }

            // تحديث الجلسة
            session.expires = Date.now() + (60 * 60 * 1000);
            localStorage.setItem("admin_session_reviewqeem", JSON.stringify(session));
        });
    </script>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-mark">RQ</div>
                    <div class="logo-text">Reviewqeem</div>
                </div>

                <nav>
                    <ul>
                        <li><a href="review-management.html" class="active">المراجعات</a></li>
                        <li><a href="comments-admin.html">التعليقات</a></li>
                        <li><a href="stats.html">الإحصائيات</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="management-header">
            <h1><i class="fas fa-newspaper"></i> إدارة المراجعات</h1>
            <p>إدارة وعرض جميع مراجعات الألعاب - مربوط بالسيرفر الحقيقي</p>
        </div>

        <!-- Controls -->
        <div class="management-controls">
            <div class="search-box">
                <input type="text" id="search-reviews" placeholder="ابحث في المراجعات...">
                <i class="fas fa-search"></i>
            </div>

            <a href="#review-form" class="btn btn-primary" id="btn-add-review">
                <i class="fas fa-plus"></i>
                إضافة مراجعة جديدة
            </a>
        </div>

        <!-- Alert -->
        <div id="alert-message" class="alert"></div>

        <!-- Reviews Table -->
        <div class="reviews-table-container">
            <div class="table-header">
                <h2><i class="fas fa-list"></i> قائمة المراجعات</h2>
                <span id="reviews-count" style="color: var(--text-secondary); font-weight: 600;">0 مراجعة</span>
            </div>

            <table class="reviews-table">
                <thead>
                    <tr>
                        <th>الصورة</th>
                        <th>العنوان</th>
                        <th>التقييم</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="reviews-table-body"></tbody>
            </table>

            <div id="loading-state" class="loading-state">
                <div class="spinner"></div>
                <p style="color: var(--text-secondary);">جاري تحميل المراجعات من السيرفر...</p>
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>لا توجد مراجعات</h3>
                <p>لم تقم بإضافة أي مراجعات حتى الآن.</p>
                <button class="btn btn-primary" id="btn-add-first">
                    <i class="fas fa-plus"></i>
                    إضافة أول مراجعة
                </button>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="review-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"><i class="fas fa-plus-circle"></i> إرسال مراجعة جديدة للنشر</h2>
                <button class="close-modal" id="btn-close-modal">&times;</button>
            </div>

            <form id="review-form">
                <input type="hidden" id="review-id">

                <div class="form-row">
                    <div class="form-group" style="width: 100%;">
                        <label><i class="fas fa-heading"></i> عنوان المراجعة</label>
                        <input type="text" id="review-title" class="form-control" placeholder="أدخل عنوان المراجعة" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-star"></i> التقييم العالمي</label>
                        <input type="number" id="review-global-rating" class="form-control" min="0" max="10" step="0.1" placeholder="9.5">
                        <small style="color: var(--text-secondary);">التقييم العالمي للعبة</small>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-star-half-alt"></i> تقييمي (من 10)</label>
                        <input type="number" id="review-rating" class="form-control" min="1" max="10" step="0.1" placeholder="9.5" required>
                        <div class="rating-indicator" id="rating-indicator">
                            <div class="rating-bar">
                                <div class="rating-fill" id="rating-fill" style="width: 0%;"></div>
                            </div>
                            <span class="rating-text" id="rating-text">0/10</span>
                        </div>
                    </div>
                </div>

                <!-- حقل رفع الصورة المحلي -->
                <div class="form-group">
                    <label><i class="fas fa-image"></i> صورة الغلاف</label>
                    <div class="image-upload-container" id="image-upload-container">
                        <div class="upload-area" id="upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>اسحب وأفلت الصورة هنا أو</p>
                            <div class="upload-btn">اختر صورة</div>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                                يسمح بـ JPEG, PNG, GIF, WebP (10MB كحد أقصى)
                            </p>
                        </div>
                        <input type="file" id="image-upload-input" accept="image/*">
                        <div class="upload-progress" id="upload-progress">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                    </div>
                    
                    <!-- معاينة الصورة -->
                    <div class="image-preview-container" id="cover-preview"></div>
                    
                    <!-- رابط الصورة المحفوظة -->
                    <input type="hidden" id="review-image-url" value="">
                    <div id="image-upload-info" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem; display: none;">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <span id="uploaded-filename"></span>
                    </div>
                </div>

                <!-- محتوى المراجعة (Rich Text Editor) -->
                <div class="form-group">
                    <label><i class="fas fa-align-left"></i> محتوى المراجعة (محرر نصي متقدم)</label>
                    <div id="review-content-editor" style="background: var(--darker-bg); border-radius: 8px; min-height: 300px;"></div>
                    <!-- Hidden field to store HTML content -->
                    <textarea id="review-content-text" style="display: none;"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <i class="fas fa-paper-plane"></i> إرسال المراجعة للنشر
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== إعدادات السيرفر ====================
        // API_BASE يعمل تلقائياً مع Vercel والمحلي
        const getApiBaseUrl = () => {
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            return isLocal ? 'http://127.0.0.1:8093/api' : '/api';
        };
        
        const API_BASE = getApiBaseUrl();
        const API_BASE_URL = API_BASE + "/reviews";
        // استخدام API الخاص بنا للرفع إلى Supabase
        const UPLOAD_API_URL = API_BASE + "/upload/single";
        const MULTI_UPLOAD_API_URL = API_BASE + "/upload/multiple";

        // ==================== المتغيرات ====================
        let allReviews = [];
        let currentEditId = null;
        let uploadedCoverImage = '';
        let uploadedScreenshots = [];

        // ==================== صور الألعاب ====================
        const GAME_IMAGES = {
            "silent hill": "/uploads/images/default/silent-hill.jpg",
            "silent hill 2": "/uploads/images/default/silent-hill-2.jpg",
            "سايلنت هيل": "/uploads/images/default/silent-hill.jpg",
            "الكابوس": "/uploads/images/default/silent-hill.jpg",
            "resident evil": "/uploads/images/default/resident-evil.jpg",
            "god of war": "/uploads/images/default/god-of-war.jpg",
            "elden ring": "/uploads/images/default/elden-ring.jpg",
            "zelda": "/uploads/images/default/zelda.jpg",
            "gta": "/uploads/images/default/gta.jpg",
            "cyberpunk": "/uploads/images/default/cyberpunk.jpg",
            "call of duty": "/uploads/images/default/cod.jpg",
            "fifa": "/uploads/images/default/fifa.jpg",
            "minecraft": "/uploads/images/default/minecraft.jpg",
            "spider-man": "/uploads/images/default/spiderman.jpg",
            "the last of us": "/uploads/images/default/last-of-us.jpg",
            "ghost of tsushima": "/uploads/images/default/ghost-tsushima.jpg",
            "final fantasy": "/uploads/images/default/final-fantasy.jpg",
            "baldur": "/uploads/images/default/baldur.jpg"
        };

        const GENRE_IMAGES = {
            "horror": "/uploads/images/default/horror.jpg",
            "action": "/uploads/images/default/action.jpg",
            "adventure": "/uploads/images/default/adventure.jpg",
            "rpg": "/uploads/images/default/rpg.jpg",
            "shooter": "/uploads/images/default/shooter.jpg",
            "sports": "/uploads/images/default/sports.jpg"
        };

        // ==================== محرر المحتوى المنظم ====================
        let editorBlocks = [];
        
        function addTextBlock() {
            const blockId = 'block-' + Date.now();
            editorBlocks.push({ id: blockId, type: 'text', content: '' });
            renderEditor();
            const block = document.getElementById(blockId);
            if (block) {
                const textarea = block.querySelector('textarea');
                if (textarea) textarea.focus();
            }
        }
        
        function addImageBlock() {
            const blockId = 'block-' + Date.now();
            editorBlocks.push({ id: blockId, type: 'image', content: '' });
            renderEditor();
        }
        
        function deleteBlock(blockId) {
            editorBlocks = editorBlocks.filter(b => b.id !== blockId);
            renderEditor();
        }
        
        let currentTextBlockId = null;
        
        function renderEditor() {
            const container = document.getElementById('editor-blocks');
            if (!container) return;
            
            container.innerHTML = editorBlocks.map(block => {
                if (block.type === 'text') {
                    return `
                        <div class="editor-block" id="${block.id}">
                            <div class="editor-block-header">
                                <span class="editor-block-type"><i class="fas fa-paragraph"></i> نص</span>
                                <button type="button" class="editor-block-delete" onclick="deleteBlock('${block.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                            <div class="editor-block-content">
                                <textarea id="textarea-${block.id}" placeholder="اكتب النص هنا..." rows="4">${block.content || ''}</textarea>
                            </div>
                        </div>
                    `;
                } else if (block.type === 'image') {
                    return `
                        <div class="editor-block" id="${block.id}">
                            <div class="editor-block-header">
                                <span class="editor-block-type"><i class="fas fa-image"></i> صورة</span>
                                <button type="button" class="editor-block-delete" onclick="deleteBlock('${block.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                            <div class="editor-block-content">
                                ${block.content ? 
                                    `<div style="position: relative; display: inline-block; width: 100%;">
                                        <img src="${block.content}" 
                                             class="editor-block-image" 
                                             alt=""
                                             style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid var(--border-color);"
                                             onerror="this.onerror=null; this.src='/uploads/images/default/default-game.jpg';">
                                        <button type="button" 
                                                onclick="changeBlockImage('${block.id}')" 
                                                style="position: absolute; top: 5px; right: 5px; background: var(--primary); color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 0.8rem;">
                                            <i class="fas fa-edit"></i> تغيير
                                        </button>
                                        <input type="hidden" class="block-image-url" value="${block.content}">
                                    </div>` :
                                    `<div class="editor-block-image-upload" onclick="uploadBlockImage('${block.id}')" style="cursor: pointer; padding: 30px; text-align: center; border: 2px dashed var(--border-color); border-radius: 8px; background: rgba(108, 92, 231, 0.05);">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                        <p style="color: var(--text-secondary); margin: 10px 0;">انقر لرفع صورة</p>
                                        <input type="file" class="block-image-input" data-block="${block.id}" accept="image/*" style="display: none;">
                                    </div>`
                                }
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            // إضافة event listeners للصور
            document.querySelectorAll('.block-image-input').forEach(input => {
                input.addEventListener('change', function() {
                    handleBlockImageUpload(this, this.dataset.block);
                });
            });
            
            // إضافة event listeners للنصوص
            editorBlocks.forEach(block => {
                if (block.type === 'text') {
                    const textarea = document.getElementById(`textarea-${block.id}`);
                    if (textarea) {
                        textarea.addEventListener('input', function() {
                            updateBlockContent(block.id, this.value);
                        });
                        textarea.addEventListener('blur', function() {
                            updateBlockContent(block.id, this.value);
                        });
                        textarea.addEventListener('focus', function() {
                            currentTextBlockId = block.id;
                        });
                    }
                }
            });
            
            updateContentField();
        }
        
        function updateBlockContent(blockId, content) {
            const block = editorBlocks.find(b => b.id === blockId);
            if (block) {
                block.content = content;
                updateContentField();
            }
        }
        
        function uploadBlockImage(blockId) {
            const input = document.querySelector(`.block-image-input[data-block="${blockId}"]`);
            if (input) {
                input.click();
                input.onchange = function() {
                    handleBlockImageUpload(this, blockId);
                };
            }
        }
        
        function changeBlockImage(blockId) {
            uploadBlockImage(blockId);
        }

        // ==================== تنسيقات داخلية للنص (غامق / تحته خط / تظليل) ====================
        function applyInlineFormat(type) {
            if (!currentTextBlockId) return;
            const textarea = document.getElementById(`textarea-${currentTextBlockId}`);
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            if (start === end) return; // لا يوجد نص محدد
            
            const value = textarea.value;
            const selected = value.slice(start, end);
            
            let before = '';
            let after = '';
            if (type === 'bold') {
                before = '<strong>';
                after = '</strong>';
            } else if (type === 'underline') {
                before = '<u>';
                after = '</u>';
            } else if (type === 'mark') {
                before = '<mark>';
                after = '</mark>';
            } else {
                return;
            }
            
            const newValue = value.slice(0, start) + before + selected + after + value.slice(end);
            textarea.value = newValue;
            updateBlockContent(currentTextBlockId, newValue);
            
            // إعادة تركيز المؤشر
            textarea.focus();
            const newEnd = end + before.length + after.length;
            textarea.setSelectionRange(start, newEnd);
        }
        
        async function handleBlockImageUpload(input, blockId) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showAlert('❌ حجم الملف كبير جداً (الحد الأقصى 10MB)', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                // Get admin token
                const session = localStorage.getItem('admin_session_reviewqeem');
                let token = localStorage.getItem('ADMIN_TOKEN');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.token) {
                            token = sessionData.token;
                        }
                    } catch (e) {}
                }
                
                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    headers: token ? {
                        'Authorization': `Bearer ${token}`
                    } : {},
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    const block = editorBlocks.find(b => b.id === blockId);
                    if (block) {
                        block.content = data.url; // حفظ رابط الصورة من Supabase
                        renderEditor();
                        updateContentField();
                        showAlert('✅ تم رفع الصورة بنجاح', 'success');
                    }
                } else {
                    throw new Error(data.message || 'فشل رفع الصورة');
                }
            } catch (error) {
                showAlert('❌ فشل رفع الصورة: ' + error.message, 'error');
            }
        }
        
        function clearEditor() {
            if (confirm('هل أنت متأكد من مسح جميع المحتوى؟')) {
                editorBlocks = [];
                renderEditor();
            }
        }
        
        function getEditorContent() {
            return editorBlocks;
        }
        
        function updateContentField() {
            const contentField = document.getElementById('review-content');
            if (contentField) {
                // تحديث الحقل المخفي بالمحتوى الحالي
                const content = editorBlocks.map(block => {
                    if (block.type === 'text') {
                        return block.content || '';
                    } else if (block.type === 'image') {
                        return block.content || '';
                    }
                    return '';
                }).filter(c => c.trim()).join('\n\n');
                contentField.value = content;
            }
        }
        
        function clearEditor() {
            if (confirm('⚠️ هل أنت متأكد من مسح جميع المحتوى؟')) {
                editorBlocks = [];
                renderEditor();
                updateContentField();
            }
        }
        
        // توليد الوسوم تلقائياً
        function generateTags(title, summary, content) {
            const text = (title + ' ' + summary + ' ' + content).toLowerCase();
            const commonWords = ['في', 'من', 'إلى', 'على', 'هذا', 'هذه', 'التي', 'الذي', 'أن', 'إن', 'لا', 'ما', 'مع', 'عن', 'كان', 'كانت', 'يكون', 'يكون', 'هو', 'هي', 'هم', 'هن', 'أنت', 'أنتم', 'أنتن', 'أنا', 'نحن', 'ال', 'و', 'أو', 'لكن', 'إذا', 'لكي', 'حتى', 'بعد', 'قبل', 'عند', 'عندما', 'حيث', 'التي', 'الذي', 'اللذان', 'اللتان', 'الذين', 'اللاتي'];
            const words = text.split(/\s+/).filter(w => w.length > 3 && !commonWords.includes(w));
            const uniqueWords = [...new Set(words)];
            return uniqueWords.slice(0, 10);
        }
        
        // مؤشر التقييم
        function updateRatingIndicator() {
            const rating = parseFloat(document.getElementById('review-rating').value) || 0;
            const fill = document.getElementById('rating-fill');
            const text = document.getElementById('rating-text');
            
            if (fill) {
                fill.style.width = (rating / 10 * 100) + '%';
            }
            
            if (text) {
                text.textContent = rating.toFixed(1) + '/10';
                
                if (rating >= 8) {
                    text.style.color = 'var(--success)';
                } else if (rating >= 6) {
                    text.style.color = 'var(--warning)';
                } else {
                    text.style.color = 'var(--danger)';
                }
            }
        }
        
        // ==================== Quill Rich Text Editor ====================
        let quillEditor = null;

        function initializeQuillEditor() {
            const editorContainer = document.getElementById('review-content-editor');
            if (!editorContainer) return;

            // Initialize Quill with custom toolbar and RTL support
            quillEditor = new Quill('#review-content-editor', {
                theme: 'snow',
                direction: 'rtl', // دعم اللغة العربية من اليمين لليسار
                modules: {
                    toolbar: {
                        container: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link', 'image'],
                            ['clean']
                        ],
                        handlers: {
                            'image': function() {
                                // Custom image handler
                                const input = document.createElement('input');
                                input.setAttribute('type', 'file');
                                input.setAttribute('accept', 'image/*');
                                input.click();

                                input.onchange = async function() {
                                    const file = input.files[0];
                                    if (!file) return;

                                    if (file.size > 10 * 1024 * 1024) {
                                        showAlert('❌ حجم الملف كبير جداً (الحد الأقصى 10MB)', 'error');
                                        return;
                                    }

                                    try {
                                        // Show loading
                                        const range = quillEditor.getSelection(true);
                                        quillEditor.insertText(range.index, 'جاري رفع الصورة...', 'user');
                                        quillEditor.setSelection(range.index + 20);

                                        // Upload image
                                        const formData = new FormData();
                                        formData.append('image', file);

                                        // Get admin token
                                        const session = localStorage.getItem('admin_session_reviewqeem');
                                        let token = localStorage.getItem('ADMIN_TOKEN');
                                        if (session) {
                                            try {
                                                const sessionData = JSON.parse(session);
                                                if (sessionData.token) {
                                                    token = sessionData.token;
                                                }
                                            } catch (e) {}
                                        }

                                        const response = await fetch(UPLOAD_API_URL, {
                                            method: 'POST',
                                            headers: token ? {
                                                'Authorization': `Bearer ${token}`
                                            } : {},
                                            body: formData
                                        });

                                        const data = await response.json();

                                        if (data.success && data.url) {
                                            // Remove loading text
                                            quillEditor.deleteText(range.index, 20);
                                            
                                            // Insert image with custom class
                                            const fullUrl = data.url.startsWith('http') ? data.url : `${window.location.origin}${data.url}`;
                                            quillEditor.insertEmbed(range.index, 'image', fullUrl);
                                            
                                            // Add custom class to image (will be applied via CSS)
                                            setTimeout(() => {
                                                const img = quillEditor.root.querySelector(`img[src="${fullUrl}"]`);
                                                if (img) {
                                                    img.classList.add('content-img');
                                                }
                                            }, 100);

                                            showAlert('✅ تم رفع الصورة وإدراجها بنجاح', 'success');
                                        } else {
                                            throw new Error(data.message || 'فشل رفع الصورة');
                                        }
                                    } catch (error) {
                                        // Remove loading text
                                        const range = quillEditor.getSelection(true);
                                        quillEditor.deleteText(range.index - 20, 20);
                                        showAlert('❌ فشل رفع الصورة: ' + error.message, 'error');
                                    }
                                };
                            }
                        }
                    }
                },
                placeholder: 'اكتب محتوى المراجعة هنا... يمكنك تنسيق النص وإدراج الصور.'
            });

            // Apply custom class to images after they're inserted
            quillEditor.on('text-change', function() {
                setTimeout(() => {
                    const images = quillEditor.root.querySelectorAll('img');
                    images.forEach(img => {
                        if (!img.classList.contains('content-img')) {
                            img.classList.add('content-img');
                        }
                    });
                }, 100);
            });
        }

        // ==================== التهيئة ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 بدء تحميل إدارة المراجعات');
            
            // إعداد مؤشر التقييم
            const ratingInput = document.getElementById('review-rating');
            if (ratingInput) {
                ratingInput.addEventListener('input', updateRatingIndicator);
                updateRatingIndicator();
            }
            
            // Initialize Quill Editor
            initializeQuillEditor();
            
            // تحميل المراجعات وإعداد الصفحة
            loadReviews();
            setupEventListeners();
            setupImageUpload();
        });

        // ==================== إعداد رفع الصور ====================
        function setupImageUpload() {
            // صورة الغلاف
            const uploadContainer = document.getElementById('image-upload-container');
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('image-upload-input');
            
            // لقطات الشاشة
            const screenshotsContainer = document.getElementById('screenshots-upload-container');
            const screenshotsArea = document.getElementById('screenshots-upload-area');
            const screenshotsInput = document.getElementById('screenshots-upload-input');
            
            // أحداث سحب وإفلات
            [uploadContainer, screenshotsContainer].forEach(container => {
                if (!container) return;
                
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                container.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                container.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (this.id === 'image-upload-container') {
                        handleCoverImageUpload(files[0]);
                    } else {
                        handleScreenshotsUpload(Array.from(files));
                    }
                });
            });
            
            // نقر على منطقة الرفع
            if (uploadArea) uploadArea.addEventListener('click', () => fileInput.click());
            if (screenshotsArea) screenshotsArea.addEventListener('click', () => screenshotsInput.click());
            
            // تغيير الملف
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        handleCoverImageUpload(e.target.files[0]);
                    }
                });
            }
            
            if (screenshotsInput) {
                screenshotsInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleScreenshotsUpload(Array.from(e.target.files));
                    }
                });
            }
        }

        // ==================== رفع صورة الغلاف ====================
        async function handleCoverImageUpload(file) {
            if (!file) return;
            
            // التحقق من نوع وحجم الملف
            if (!file.type.startsWith('image/')) {
                showAlert('❌ الملف يجب أن يكون صورة', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showAlert('❌ حجم الملف كبير جداً (الحد الأقصى 10MB)', 'error');
                return;
            }
            
            // إظهار شريط التقدم
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('upload-progress');
            if (progressContainer) progressContainer.style.display = 'block';
            if (progressBar) progressBar.style.width = '0%';
            
            try {
                // ==================== مرحلة "الاستلام والرفع" ====================
                // إرسال الملف إلى خدمة الرفع في السيرفر (Node) التي ترفعه مباشرة إلى Supabase
                const formData = new FormData();
                // IMPORTANT: يجب أن يكون اسم الحقل "image" ليتطابق مع upload.single('image') في routes/upload.js
                formData.append('image', file);
                
                // محاكاة شريط التقدم
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    if (progressBar) progressBar.style.width = progress + '%';
                    if (progress >= 90) clearInterval(interval);
                }, 100);
                
                // Get admin token
                const session = localStorage.getItem('admin_session_reviewqeem');
                let token = localStorage.getItem('ADMIN_TOKEN');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.token) {
                            token = sessionData.token;
                        }
                    } catch (e) {}
                }

                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    headers: token ? {
                        'Authorization': `Bearer ${token}`
                    } : {},
                    body: formData
                });
                
                clearInterval(interval);
                if (progressBar) progressBar.style.width = '100%';
                
                const data = await response.json();
                
                if (data.success) {
                    // ==================== مرحلة "توليد الرابط" ====================
                    // الرابط تم توليده من Flask service مباشرة من Supabase
                    uploadedCoverImage = data.url;  // الرابط العام من Supabase
                    document.getElementById('review-image-url').value = uploadedCoverImage;
                    
                    // إظهار المعلومات
                    const uploadInfo = document.getElementById('image-upload-info');
                    const filenameSpan = document.getElementById('uploaded-filename');
                    if (uploadInfo) uploadInfo.style.display = 'block';
                    if (filenameSpan) {
                        filenameSpan.textContent = `تم رفع الصورة وتحويلها إلى رابط: ${file.name}`;
                    }
                    
                    // معاينة الصورة
                    updateImagePreview(uploadedCoverImage);
                    
                    setTimeout(() => {
                        if (progressContainer) progressContainer.style.display = 'none';
                        if (progressBar) progressBar.style.width = '0%';
                    }, 1000);
                    
                    showAlert('✅ تم رفع الصورة بنجاح', 'success');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('❌ خطأ في رفع الصورة:', error);
                showAlert('❌ فشل رفع الصورة: ' + error.message, 'error');
                if (progressContainer) progressContainer.style.display = 'none';
                if (progressBar) progressBar.style.width = '0%';
            }
        }

        // ==================== رفع لقطات الشاشة ====================
        async function handleScreenshotsUpload(files) {
            if (!files || files.length === 0) return;
            
            // التحقق من عدد الملفات
            const maxFiles = 10;
            if (files.length > maxFiles) {
                showAlert(`❌ الحد الأقصى ${maxFiles} صور`, 'error');
                files = files.slice(0, maxFiles);
            }
            
            // التحقق من حجم الملفات
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showAlert('❌ حجم الملف كبير جداً (الحد الأقصى 10MB)', 'error');
                    return;
                }
            }
            
            try {
                // ==================== رفع عدة صور إلى Supabase ====================
                const formData = new FormData();
                files.forEach(file => formData.append('images', file));
                
                // Get admin token
                const session = localStorage.getItem('admin_session_reviewqeem');
                let token = localStorage.getItem('ADMIN_TOKEN');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.token) {
                            token = sessionData.token;
                        }
                    } catch (e) {}
                }

                const response = await fetch(MULTI_UPLOAD_API_URL, {
                    method: 'POST',
                    headers: token ? {
                        'Authorization': `Bearer ${token}`
                    } : {},
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ==================== الحصول على الروابط العامة ====================
                    // الروابط تم توليدها من Flask service مباشرة من Supabase
                    const newScreenshots = data.files.map(item => item.url);
                    uploadedScreenshots = [...uploadedScreenshots, ...newScreenshots];
                    
                    // تحديث معاينة الصور
                    updateScreenshotsPreview();
                    
                    showAlert(`✅ تم رفع ${newScreenshots.length} صورة بنجاح`, 'success');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('❌ خطأ في رفع لقطات الشاشة:', error);
                showAlert('❌ فشل رفع الصور: ' + error.message, 'error');
            }
        }

        // ==================== معاينة صورة الغلاف ====================
        function updateImagePreview(url) {
            const container = document.getElementById('cover-preview');
            if (!container) return;
            
            if (!url || url === '') {
                container.innerHTML = '';
                return;
            }
            
            // إذا كانت URL من Supabase (تبدأ بـ http)، استخدمها مباشرة
            const fullUrl = url.startsWith('http') ? url : (url.startsWith('/') ? url : `/${url}`);
            
            container.innerHTML = `
                <div class="image-preview">
                    <img src="${fullUrl}" 
                         onerror="this.onerror=null; this.src='/uploads/images/default/default-game.jpg';" 
                         style="max-width: 100%; height: auto; border-radius: 8px;">
                    <button type="button" class="remove-image" onclick="removeCoverImage()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        // ==================== معاينة لقطات الشاشة ====================
        function updateScreenshotsPreview(screenshots = null) {
            const container = document.getElementById('screenshots-preview');
            if (!container) return;
            
            const screenshotsToShow = screenshots || uploadedScreenshots;
            
            if (!screenshotsToShow || screenshotsToShow.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = screenshotsToShow.map((url, index) => {
                const fullUrl = url && url.startsWith('http') ? url : (url ? (url.startsWith('/') ? url : `/${url}`) : '/uploads/images/default/default-game.jpg');
                return `
                    <div class="image-preview">
                        <img src="${fullUrl}" 
                             onerror="this.onerror=null; this.src='/uploads/images/default/default-game.jpg';" 
                             style="max-width: 100%; height: auto; border-radius: 8px;">
                        <button type="button" class="remove-image" onclick="removeScreenshot(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // تحديث الحقل المخفي
            const hiddenInput = document.getElementById('review-screenshots-urls');
            if (hiddenInput) hiddenInput.value = JSON.stringify(screenshotsToShow);
            
            if (screenshots) {
                uploadedScreenshots = [...screenshots];
            }
        }

        // ==================== حذف صورة الغلاف ====================
        function removeCoverImage() {
            uploadedCoverImage = '';
            const imageUrlInput = document.getElementById('review-image-url');
            const uploadInfo = document.getElementById('image-upload-info');
            if (imageUrlInput) imageUrlInput.value = '';
            if (uploadInfo) uploadInfo.style.display = 'none';
            updateImagePreview('');
        }

        // ==================== حذف لقطة شاشة ====================
        function removeScreenshot(index) {
            uploadedScreenshots.splice(index, 1);
            updateScreenshotsPreview();
        }

        // ==================== ربط الأحداث ====================
        function setupEventListeners() {
            // زر إضافة مراجعة: ينقل المستخدم مباشرة إلى نموذج الإضافة ويجهّز الحقول
            const addBtn = document.getElementById('btn-add-review');
            const addFirstBtn = document.getElementById('btn-add-first');
            if (addBtn) {
                addBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    openAddModal();
                });
            }
            if (addFirstBtn) {
                addFirstBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    openAddModal();
                });
            }
            
            // إغلاق المودال
            const closeBtn = document.getElementById('btn-close-modal');
            const cancelBtn = document.getElementById('btn-cancel');
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
            
            // البحث
            const searchInput = document.getElementById('search-reviews');
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            
            // النموذج
            const form = document.getElementById('review-form');
            if (form) form.addEventListener('submit', handleFormSubmit);
            
            // إغلاق المودال بالنقر خارجها
            const modal = document.getElementById('review-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) closeModal();
                });
            }
        }

        // ==================== تحويل بيانات السيرفر ====================
        function mapServerReview(r) {
            if (!r) return null;
            return {
                id: r._id || r.id,
                title: r.title || "",
                rating: typeof r.rating === "number" ? r.rating : 0,
                globalRating: typeof r.globalRating === "number" ? r.globalRating : null,
                cover_image: r.cover_image || r.mainImage || r.coverImage || "/uploads/images/default/default-game.jpg",
                summary: r.summary || "",
                screenshots: Array.isArray(r.screenshots) ? r.screenshots : [],
                pros: Array.isArray(r.pros) ? r.pros : [],
                cons: Array.isArray(r.cons) ? r.cons : [],
                content: r.content || "",
                tags: Array.isArray(r.tags) ? r.tags : [],
                status: (r.status || "published").toLowerCase(),
                comments_enabled: r.comments_enabled !== false
            };
        }

        // ==================== إزالة التكرارات ====================
        function removeDuplicates(reviews) {
            const seen = new Map();
            return reviews.filter(r => {
                const key = (r.title + '_' + r.rating).toLowerCase();
                if (seen.has(key)) return false;
                seen.set(key, true);
                return true;
            });
        }

        // ==================== تحميل المراجعات ====================
        async function loadReviews() {
            showLoading();

            try {
                // Get admin token
                const session = localStorage.getItem('admin_session_reviewqeem');
                let token = localStorage.getItem('ADMIN_TOKEN');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.token) {
                            token = sessionData.token;
                        }
                    } catch (e) {}
                }

                console.log('📡 جلب المراجعات من:', API_BASE_URL);
                const res = await fetch(API_BASE_URL, {
                    method: 'GET',
                    headers: token ? {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    } : {}
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('📦 البيانات المستلمة:', data);

                if (data.success) {
                    allReviews = removeDuplicates(
                        (data.data || data.reviews || []).map(mapServerReview).filter(Boolean)
                    );
                    console.log('✅ تم تحميل', allReviews.length, 'مراجعة');
                } else {
                    throw new Error(data.message || 'فشل تحميل المراجعات');
                }
            } catch (err) {
                console.error('❌ خطأ:', err);
                allReviews = [];
                showAlert('⚠️ تعذر الاتصال بالسيرفر: ' + err.message, 'error');
            }

            displayReviews();
            hideLoading();
        }

        // ==================== عرض المراجعات ====================
        function displayReviews() {
            const tbody = document.getElementById('reviews-table-body');
            const empty = document.getElementById('empty-state');

            if (!allReviews.length) {
                if (empty) empty.style.display = 'block';
                if (tbody) tbody.innerHTML = '';
                updateStats();
                return;
            }

            if (empty) empty.style.display = 'none';
            if (tbody) tbody.innerHTML = allReviews.map(r => createReviewRow(r)).join('');
            
            // ربط أحداث الأزرار
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    editReview(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteReview(this.dataset.id);
                });
            });

            updateStats();
        }

        // ==================== إنشاء صف المراجعة ====================
        function createReviewRow(r) {
            // البحث عن الصورة في عدة حقول محتملة
            const img = r.cover_image || r.coverImage || r.mainImage || getDefaultImage(r.title, r.genre);
            const fullImgUrl = img && img.startsWith('http') ? img : (img ? (img.startsWith('/') ? img : `/${img}`) : '/uploads/images/default/default-game.jpg');
            const statusClass = r.status === 'published' ? 'status-published' : 'status-draft';
            const statusText = r.status === 'published' ? 'منشور' : 'مسودة';
            const statusIcon = r.status === 'published' ? 'fa-check-circle' : 'fa-edit';

            return `
                <tr>
                    <td><img src="${fullImgUrl}" alt="${r.title}" class="review-image" onerror="this.src='${getDefaultImage(r.title, '')}'"></td>
                    <td>
                        <strong style="color: var(--text-primary);">${r.title}</strong>
                    </td>
                    <td>
                        <span class="rating-badge"><i class="fas fa-star"></i> ${r.rating}/10</span>
                        ${r.globalRating ? '<br><small style="color: var(--text-secondary);">عالمي: ' + r.globalRating + '/10</small>' : ''}
                    </td>
                    <td><span class="status-badge ${statusClass}"><i class="fas ${statusIcon}"></i> ${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit btn-sm" data-id="${r.id}">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-delete btn-sm" data-id="${r.id}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // ==================== الصورة الافتراضية ====================
        function getDefaultImage(title, genre) {
            if (!title) return '/uploads/images/default/default-game.jpg';
            
            const t = title.toLowerCase();
            
            for (const [key, url] of Object.entries(GAME_IMAGES)) {
                if (t.includes(key)) return url;
            }
            
            if (genre && GENRE_IMAGES[genre.toLowerCase()]) {
                return GENRE_IMAGES[genre.toLowerCase()];
            }
            
            return '/uploads/images/default/default-game.jpg';
        }

        // ==================== فتح نموذج الإضافة (في مودال واضح) ====================
        function openAddModal() {
            currentEditId = null;
            uploadedCoverImage = '';
            uploadedScreenshots = [];
            editorBlocks = [];
            
            const form = document.getElementById('review-form');
            if (form) {
                form.reset();
            }

            // إعادة تعيين حالة الرفع والمعاينات
            uploadedCoverImage = '';
            uploadedScreenshots = [];
            updateImagePreview('');
            updateScreenshotsPreview();
            updateRatingIndicator();

            // Clear Quill editor
            if (quillEditor) {
                quillEditor.setText('');
            }

            const uploadInfo = document.getElementById('image-upload-info');
            if (uploadInfo) uploadInfo.style.display = 'none';

            // إظهار نافذة المودال فعلياً
            const modal = document.getElementById('review-modal');
            if (modal) {
                modal.style.display = 'block';
            }

            // تركيز المؤشر على العنوان
            const titleInput = document.getElementById('review-title');
            if (titleInput) {
                setTimeout(() => titleInput.focus(), 200);
            }
        }

        // ==================== تعديل مراجعة ====================
        function editReview(id) {
            const r = allReviews.find(x => x.id === id);
            if (!r) return showAlert('لم يتم العثور على المراجعة', 'error');

            currentEditId = id;
            uploadedCoverImage = r.cover_image || r.coverImage || '';
            uploadedScreenshots = [...(r.screenshots || [])];
            
            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) modalTitle.innerHTML = '<i class="fas fa-edit"></i> تعديل المراجعة';
            
            document.getElementById('review-title').value = r.title || '';
            document.getElementById('review-rating').value = r.rating || '';
            
            // Load content into Quill editor
            if (quillEditor && r.content) {
                quillEditor.root.innerHTML = r.content;
                // Apply content-img class to existing images
                setTimeout(() => {
                    const images = quillEditor.root.querySelectorAll('img');
                    images.forEach(img => {
                        if (!img.classList.contains('content-img')) {
                            img.classList.add('content-img');
                        }
                    });
                }, 100);
            } else {
                // Fallback to textarea
                const contentInput = document.getElementById('review-content-text');
                if (contentInput) {
                    contentInput.value = r.content || '';
                }
            }
            
            updateRatingIndicator();
            updateImagePreview(r.cover_image || r.coverImage || '');
            updateScreenshotsPreview(r.screenshots || []);
            
            const modal = document.getElementById('review-modal');
            if (modal) modal.style.display = 'block';
        }

        // ==================== إغلاق المودال ====================
        function closeModal() {
            const modal = document.getElementById('review-modal');
            if (modal) modal.style.display = 'none';
            currentEditId = null;
        }

        // ==================== حفظ المراجعة (عنوان + صورة غلاف + تقييم + نص بسيط) ====================
        async function handleFormSubmit(e) {
            e.preventDefault();

            const titleInput = document.getElementById('review-title');
            const ratingInput = document.getElementById('review-rating');
            const coverImage = uploadedCoverImage || '';

            const title = titleInput ? titleInput.value.trim() : '';
            const rating = ratingInput ? parseFloat(ratingInput.value) : 0;
            
            // Get HTML content from Quill editor
            let contentHTML = '';
            let contentText = '';
            if (quillEditor) {
                contentHTML = quillEditor.root.innerHTML;
                contentText = quillEditor.getText().trim();
                // Update hidden textarea for compatibility
                const contentInput = document.getElementById('review-content-text');
                if (contentInput) {
                    contentInput.value = contentHTML;
                }
            } else {
                // Fallback to textarea if Quill is not initialized
                const contentInput = document.getElementById('review-content-text');
                contentText = contentInput ? contentInput.value.trim() : '';
                contentHTML = contentText
                    ? '<p>' + contentText.replace(/\n+/g, '</p><p>') + '</p>'
                    : '';
            }

            if (!title || !rating || isNaN(rating)) {
                return showAlert('يرجى إدخال عنوان المراجعة والتقييم (من 1 إلى 10) قبل إرسالها للنشر', 'error');
            }

            // Extract plain text for summary (remove HTML tags)
            const summaryText = contentText.replace(/<[^>]+>/g, '').slice(0, 200);

            const body = {
                title: title,
                gameName: title,
                // Save as HTML to preserve formatting and images
                content: contentHTML,
                summary: summaryText,
                rating: rating,
                globalRating: rating,
                pros: [],
                cons: [],
                tags: [],
                cover_image: coverImage,
                coverImage: coverImage,
                mainImage: coverImage,
                screenshots: [],
                status: 'published',           // حتى تظهر في /reviews/published
                comments_enabled: true
            };

            const isEdit = !!currentEditId;
            const url = isEdit ? `${API_BASE_URL}/${currentEditId}` : API_BASE_URL;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                // Get admin token
                const session = localStorage.getItem('admin_session_reviewqeem');
                let token = localStorage.getItem('ADMIN_TOKEN');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.token) {
                            token = sessionData.token;
                        }
                    } catch (e) {}
                }

                console.log('📤 إرسال المراجعة المبسطة:', body);

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const txt = await res.text();
                    console.error('HTTP Error body:', txt);
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();
                console.log('📤 رد السيرفر:', data);

                if (!data.success) throw new Error(data.message || 'فشل نشر المراجعة');

                currentEditId = null;
                await loadReviews();
                // نص الرسالة يوضح أن المراجعة تم نشرها (وليست مجرد حفظ مسودة)
                showAlert(isEdit ? '✅ تم تحديث المراجعة المنشورة بنجاح' : '✅ تم نشر المراجعة بنجاح', 'success');

                const form = document.getElementById('review-form');
                if (form) form.reset();
                uploadedCoverImage = '';
                uploadedScreenshots = [];
                updateImagePreview('');
                updateScreenshotsPreview();
                updateRatingIndicator();
                const uploadInfo = document.getElementById('image-upload-info');
                if (uploadInfo) uploadInfo.style.display = 'none';

            } catch (err) {
                console.error('❌ خطأ في نشر المراجعة:', err);
                showAlert('❌ خطأ في نشر المراجعة: ' + err.message, 'error');
            }
        }

        // ==================== حذف مراجعة ====================
        async function deleteReview(id) {
            if (!confirm('⚠️ هل أنت متأكد من الحذف؟')) return;

            try {
                // Get admin token
                const session = localStorage.getItem('admin_session_reviewqeem');
                let token = localStorage.getItem('ADMIN_TOKEN');
                if (session) {
                    try {
                        const sessionData = JSON.parse(session);
                        if (sessionData.token) {
                            token = sessionData.token;
                        }
                    } catch (e) {}
                }

                const res = await fetch(API_BASE_URL + '/' + id, {
                    method: 'DELETE',
                    headers: token ? {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    } : {}
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();
                if (!data.success) throw new Error(data.message);

                await loadReviews();
                showAlert('✅ تم الحذف بنجاح', 'success');

            } catch (err) {
                showAlert('❌ فشل الحذف: ' + err.message, 'error');
            }
        }

        // تم حذف دوال المنصات - لم تعد مستخدمة

        // ==================== البحث ====================
        function handleSearch(e) {
            const q = e.target.value.toLowerCase().trim();
            
            if (!q) {
                displayReviews();
                return;
            }

            const filtered = allReviews.filter(r =>
                r.title.toLowerCase().includes(q) ||
                r.developer.toLowerCase().includes(q) ||
                (r.summary && r.summary.toLowerCase().includes(q)) ||
                (r.tags && r.tags.some(tag => tag.toLowerCase().includes(q)))
            );

            const tbody = document.getElementById('reviews-table-body');
            const empty = document.getElementById('empty-state');

            if (!filtered.length) {
                if (empty) empty.style.display = 'block';
                if (tbody) tbody.innerHTML = '';
            } else {
                if (empty) empty.style.display = 'none';
                if (tbody) tbody.innerHTML = filtered.map(r => createReviewRow(r)).join('');
                
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() { editReview(this.dataset.id); });
                });
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() { deleteReview(this.dataset.id); });
                });
            }
        }

        // ==================== دوال مساعدة ====================
        function getGenreText(g) {
            const map = {
                'action': 'أكشن', 'adventure': 'مغامرة', 'rpg': 'ألعاب أدوار',
                'horror': 'رعب', 'shooter': 'تصويب', 'racing': 'سباقات',
                'sports': 'رياضة', 'strategy': 'إستراتيجية', 'simulation': 'محاكاة',
                'fighting': 'قتال', 'puzzle': 'ألغاز', 'open-world': 'عالم مفتوح',
                'indie': 'مستقلة', 'survival': 'بقاء'
            };
            return map[g] || g;
        }

        function formatDate(d) {
            if (!d) return 'N/A';
            return new Date(d).toLocaleDateString('ar-EG', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        function updateStats() {
            const pub = allReviews.filter(r => r.status === 'published').length;
            const draft = allReviews.filter(r => r.status === 'draft').length;
            const countEl = document.getElementById('reviews-count');
            if (countEl) {
                countEl.textContent = allReviews.length + ' مراجعة (' + pub + ' منشورة، ' + draft + ' مسودة)';
            }
        }

        function showLoading() {
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            const tbody = document.getElementById('reviews-table-body');
            if (loading) loading.style.display = 'block';
            if (empty) empty.style.display = 'none';
            if (tbody) tbody.innerHTML = '';
        }

        function hideLoading() {
            const loading = document.getElementById('loading-state');
            if (loading) loading.style.display = 'none';
        }

        function showAlert(msg, type) {
            const el = document.getElementById('alert-message');
            if (!el) return;
            el.textContent = msg;
            el.className = 'alert alert-' + type;
            el.style.display = 'block';
            setTimeout(function() { el.style.display = 'none'; }, 5000);
        }

        // جعل الدوال متاحة عالمياً
        window.removeCoverImage = removeCoverImage;
        window.removeScreenshot = removeScreenshot;
        window.editReview = editReview;
        window.deleteReview = deleteReview;

        console.log('✅ إدارة المراجعات جاهزة');
    </script>
</body>
</html>